{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<h2 class="mb-4">{{ title }}</h2>

<form method="post" class="row g-3">
    {% csrf_token %}

    <div class="col-md-6">
        <label class="form-label">Статус</label>
        {{ form.cstatus }}
    </div>

    <div class="col-md-6">
        <label class="form-label">Клиент</label>
        {{ form.client }}
    </div>

    <div class="col-md-6">
        <label class="form-label">Автомобиль</label>
        {{ form.car }}
    </div>

    <div class="col-md-6">
        <label class="form-label">Дата оформления</label>
        {{ form.created_at }}
    </div>

    <div class="col-md-6">
        <label class="form-label">Дата выдачи</label>
        {{ form.issue_date }}
    </div>

    <div class="col-md-6">
        <label class="form-label">Дата возврата</label>
        {{ form.return_date }}
    </div>

    <div class="col-md-6">
        <label class="form-label">Форма оплаты</label>
        {{ form.payment }}
    </div>

    <div class="col-md-6">
        <label class="form-label">Филиал выдачи</label>
        {{ form.issue_branch }}
    </div>

    <div class="col-md-6">
        <label class="form-label">Филиал возврата</label>
        {{ form.return_branch }}
    </div>

    <div class="col-md-6">
        <label class="form-label">Цена за сутки</label>
        {{ form.daily_price }}
    </div>

    <div class="col-md-6">
        <label class="form-label">Итоговая сумма</label>
        {{ form.total_amount }}
    </div>

    {% if form.errors %}
    <div class="col-12">
        <div class="alert alert-danger">
            {{ form.errors }}
        </div>
    </div>
    {% endif %}

    <div class="col-12 mt-3">
        <button class="btn btn-success">Сохранить</button>
        <a href="{% url 'contract_list' %}" class="btn btn-secondary ms-2">Назад</a>
    </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const carSelect = document.getElementById("id_car");
    const issueDate = document.getElementById("id_issue_date");
    const returnDate = document.getElementById("id_return_date");
    const dailyPrice = document.getElementById("id_daily_price");
    const totalAmount = document.getElementById("id_total_amount");

    totalAmount.readOnly = true;

    function calculateTotal() {
        if (!issueDate.value || !returnDate.value || !dailyPrice.value) {
            totalAmount.value = "";
            return;
        }

        const start = new Date(issueDate.value);
        const end = new Date(returnDate.value);

        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

        if (days > 0) {
            totalAmount.value = (days * parseFloat(dailyPrice.value)).toFixed(2);
        }
    }

    carSelect.addEventListener("change", function () {
        if (!this.value) return;

        fetch(`/cars/get_price/${this.value}/`)
            .then(r => r.json())
            .then(data => {
                dailyPrice.value = data.daily_price;
                calculateTotal();
            });
    });

    issueDate.addEventListener("change", calculateTotal);
    returnDate.addEventListener("change", calculateTotal);
});
</script>


{% endblock %}
